## backend

### Set up

#### Instructions
To set up your environment:
- In your terminal, deactivate any conda environments/venvs/etc. Try to match python version 3.7.
- Run `python -m venv .pms-backend-env` (or `python3` if need be)
- Run `source .pms-backend-env/bin/activate` to activate your pip environment.
- Run `python -m pip install -r requirements.txt` to install all required dependencies.

If you need to install other packages for you code, add them to requirements.txt so we are all always on the same page. You can add the requirements manually, or while having `.pms-backend-env` activated, run `python -m pip freeze > requirements.txt`. 

__Note__: I have found that if we simply run `pip install` rather than `python -m pip install`, etc. then you may encounter some installation errors if you are using WSL. This is why I recommend using the latter.

#### Environment Variables

For token authentication we require a secret key configured in an environment variable. You will need to run the following command each time you wish to run some backend code:
```
export PMS_SECRET_KEY="\xe4\x0c\x91\xd8\xc3\xa6\xb4\x17N\x83\xb3n\xb8I[\x9b0\x18V\x08,\x98\xcc8"
```

#### Mapbox

We are using MapboxGL for our map components. The mapbox api key is contained in the file that uses it. You will need to run the following command each time you wish to run some backend code:
```
export MAPBOX_API_KEY="pk.eyJ1IjoiZHdvb2xub3VnaCIsImEiOiJja3YzZjhnaGcwa3ZnMm9wNm5oaXh3MTYxIn0.2AEDoHcYKsk_ta0AxPXeBA"
```
#### Linting

To maintain a common code format between us, please run the script `backend/format.sh` to format your python files nicely. You should do this before every push to github.

#### Run Flask

To run Flask, in your terminal do the following from the `capstone-project-9900-t16a-bigai/backend` directory:
- `export PMS_SECRET_KEY="\xe4\x0c\x91\xd8\xc3\xa6\xb4\x17N\x83\xb3n\xb8I[\x9b0\x18V\x08,\x98\xcc8"`
- `export MAPBOX_API_KEY="pk.eyJ1IjoiZHdvb2xub3VnaCIsImEiOiJja3YzZjhnaGcwa3ZnMm9wNm5oaXh3MTYxIn0.2AEDoHcYKsk_ta0AxPXeBA"`
- `export FLASK_APP=backend`
- `export FLASK_DEBUG=1` (this may be optional)
- Environment: `source .pms-backend-env/bin/activate` (you may need to deactivate any conda environments first)
- `flask run --port 5005`


### Tokens

To handle all of our token generation, authentication, processing, and blacklisting, we have created a Python decorator that wraps over any routes, `auth_required`, located in `backend/utils.py`. Using this wrapper, you __should not need to authenticate tokens, or create and return tokens in any response body__. The optional keyword arguments that can be supplied to `auth_required` can be used to customize its behaviour, and should be suitable for all scenarios (if you require further customization, feel to add and PR it yourself, or request it). The optional args are:
- `check_token`: Whether to pull a token from the request headers and authenticate it. Defaults to True. Disabling is useful if tokens will not be supplied - for example, a login request supplied no token.
- `gen_token`: Whether to create a token and add it to the route response. Defaults to True. Disabling is useful if no token is to be generated by the route - for example, logout.
- `gen_token_on_error`: Whether to generate a token and add it to the route response, if the route response status is not `200 OK`. Default is True. Disabling can be useful in certain situations - e.g. first registration page requires no token to be made if the user supplied bad data.

_For most routes, i.e. essentially all routes while a user is logged in, all of these arguments should remain `True`. This is because our routes require us to authenticate the current token for the user, and then provide a new one moving forward, as we cannot use a blacklisted token. We also require `gen_data_on_error` since if a user makes a bad request, not generating a new token will also have them booted._

- `check_user_status`: Whether to reject an authentication if the user status is offline. Defaults to True. Should be disabled if using tokens outside scope of a logged in session; e.g. reset tokens.
- `reset`: Whether we are using reset tokens. Defaults to False (i.e. auth tokens)
- `reset_val`: If `reset` is True, this parameter determines the current step of the reset process (can be 1, 2, or 3).

#### Front End Considerations

When creating routes, you may need to alter the front-end to ensure it handles tokens correctly. See `RegisterScreen.js` and `RegisterScreen2.js` for the two main methods of handling response status and data, including token storage. You will need to adapt this to your needs. 

#### 500: Internal Error

In some cases we will return a status `500: Internal Error`, which indicates we have fucked something up. In these cases the error message helps to identify and debug the problem for you, which may be displayed either on the backend log, or the frontend console.

If returning status `500`, ensure to make your `error` message verbose and helpful about why something has gone wrong, and be sure to prepend any logs with the internal indicator `::ERROR::`.
